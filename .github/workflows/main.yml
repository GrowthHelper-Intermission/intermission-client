name: iOS App Store Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: í˜„ì¬ ë¹Œë“œ ë²ˆí˜¸ ì¶”ì¶œí•˜ì—¬ +1ì„ í•œ í›„ $GITHUB_ENV í™˜ê²½ë³€ìˆ˜ë¡œ ë“±ë¡
        run: |
          version=$(grep 'version:' pubspec.yaml | awk '{print $2}')
          echo "Current version: $version"
          IFS='+' read -r base_version build_number <<< "$version"
          build_number=$((build_number + 1))
          new_version="${base_version}+${build_number}"
          echo "New version: $new_version"
          echo "NEW_VERSION=$new_version" >> $GITHUB_ENV

      - name: ğŸ” ios ë¹Œë“œ ê´€ë ¨ íŒŒì¼ ì„¤ì¹˜
        env:
          P12_DISTRIBUTION_CERTIFICATE_BASE64: ${{ secrets.IOS_P12_DISTRIBUTION_CERTIFICATE_BASE64 }}
          P12_DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.IOS_P12_DISTRIBUTION_CERTIFICATE_PASSWORD }}
          DISTRIBUTION_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_DISTRIBUTION_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_RUNNER_LOCAL_KEYCHAIN_PASSWORD }}
          EXPORT_OPTIONS_BASE64: ${{ secrets.IOS_EXPORT_OPTIONS_BASE64 }}
        run: |
          # [iOS ë¹Œë“œ ê´€ë ¨ íŒŒì¼ ì„¤ì¹˜ ë° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸]

      - name: ğŸ” android ë¹Œë“œ ê´€ë ¨ íŒŒì¼ ì„¤ì¹˜
        run: |
          # [Android ë¹Œë“œ ê´€ë ¨ íŒŒì¼ ì„¤ì¹˜ ë° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸]

      - uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'

      - uses: subosito/flutter-action@v2.3.0
        with:
          flutter-version: '3.16.5'

      - name: Install packages
        run: flutter pub get

      - name: Build ipa
        run: |
          flutter build ipa \
            --release \
            --flavor dev \
            --export-options-plist=ios/Runner/ExportOptions.plist

      - name: ì‚¬ìš©í•  app store connect api í‚¤ ê°€ì ¸ì˜¤ê¸°
        env:
          PRIVATE_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64 }}
          API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        run: | 
          mkdir -p ~/private_keys
          echo -n "$PRIVATE_API_KEY_BASE64" | base64 --decode --output ~/private_keys/AuthKey_$API_KEY.p8

      - name: TestFlightì— ì—…ë¡œë“œ
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID  }}
        run: xcrun altool --output-format xml --upload-app -f ${{ github.workspace }}/build/ios/ipa/pjname.ipa -t ios --apiKey $API_KEY --apiIssuer $API_ISSUER

      - name: Build apk
        run: |
          flutter build apk \
            --release \
            --flavor dev

      - name: ì˜¤ëŠ˜ ë‚ ì§œì— ë”°ë¼ apk íŒŒì¼ëª… ì„¤ì •
        run: echo "TODAYS_DATE=$(date +%y%m%d)" >> $GITHUB_ENV

      - name: Google Driveì— apk íŒŒì¼ ì—…ë¡œë“œ
        uses: willo32/google-drive-upload-action@v1
        with:
          credentials: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
          target: ${{ github.workspace }}/build/app/outputs/flutter-apk/app-dev-release.apk
          parent_folder_id: ${{ secrets.GOOGLE_DRIVE_DEV_FOLDER_ID }}
          name: dev_${{ env.TODAYS_DATE }}.apk
