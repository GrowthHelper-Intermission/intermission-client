name: Version Sync on Main

on:
  push:
    branches: [ "main" ]

jobs:
  version-sync:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.INTERMISSION_PERSONAL_ACCESS_TOKEN }}
        
    - name: Update version in pubspec.yaml
      run: |
        version=$(grep 'version:' pubspec.yaml | awk '{print $2}')
        echo "Current version: $version"
        IFS='+' read -r base_version build_number <<< "$version"
        build_number=$((build_number + 1))
        new_version="${base_version}+${build_number}"
        echo "New version: $new_version"
        sed -i '' "s/version: .*/version: $new_version/" pubspec.yaml

    - name: Commit and push version update
      run: |
        git config --global user.name 'puretension'
        git config --global user.email 'rlrlfhtm5@gmail.com'
        git add pubspec.yaml
        git commit -m "Update version number to $new_version"
        git push origin main
